<!doctype html>
<html class="theme-next ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="python,generator," />





  <link rel="alternate" href="/atom.xml" title="钱唯の个人博客" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="python generator的设计考虑在一般的程序设计中，function的调用是这样的：从第一行开始，一种执行到return语句结束。这种模式有一个特点:

单一入口（entry point), 无论调用多少次，都从函数第一行开始
无状态（Stateless），即函数的local变量每次都重新初始化，上一次被调用的状态丢失
return返回控制权给caller,除非再次调用，控制权不会回来。">
<meta property="og:type" content="article">
<meta property="og:title" content="Python generator">
<meta property="og:url" content="http://paranoidq.github.io/2016/05/27/Python-generator/index.html">
<meta property="og:site_name" content="钱唯の个人博客">
<meta property="og:description" content="python generator的设计考虑在一般的程序设计中，function的调用是这样的：从第一行开始，一种执行到return语句结束。这种模式有一个特点:

单一入口（entry point), 无论调用多少次，都从函数第一行开始
无状态（Stateless），即函数的local变量每次都重新初始化，上一次被调用的状态丢失
return返回控制权给caller,除非再次调用，控制权不会回来。">
<meta property="og:updated_time" content="2016-05-27T15:45:36.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Python generator">
<meta name="twitter:description" content="python generator的设计考虑在一般的程序设计中，function的调用是这样的：从第一行开始，一种执行到return语句结束。这种模式有一个特点:

单一入口（entry point), 无论调用多少次，都从函数第一行开始
无状态（Stateless），即函数的local变量每次都重新初始化，上一次被调用的状态丢失
return返回控制权给caller,除非再次调用，控制权不会回来。">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post',
    motion: false
  };
</script>

  <title> Python generator | 钱唯の个人博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">钱唯の个人博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">佳思忽来，书能下酒；侠情一往，云可赠人。</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tops">
          <a href="/tags/top/" rel="section">
            
              <i class="menu-item-icon fa fa-收藏 fa-fw"></i> <br />
            
            收藏
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/tags/碎片/" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            碎片
          </a>
        </li>
      
        
        <li class="menu-item menu-item-todo">
          <a href="/tags/todo/" rel="section">
            
              <i class="menu-item-icon fa fa-TODO fa-fw"></i> <br />
            
            待办
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Python generator
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            更新于
            <time itemprop="dateCreated" datetime="2016-05-27T23:45:36+08:00" content="2016-05-27">
              2016-05-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/27/Python-generator/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/27/Python-generator/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><h3 id="python_generator_u7684_u8BBE_u8BA1_u8003_u8651"><a href="#python_generator_u7684_u8BBE_u8BA1_u8003_u8651" class="headerlink" title="python generator的设计考虑"></a>python generator的设计考虑</h3><p>在一般的程序设计中，function的调用是这样的：从第一行开始，一种执行到return语句结束。这种模式有一个特点:</p>
<ol>
<li>单一入口（entry point), 无论调用多少次，都从函数第一行开始</li>
<li>无状态（Stateless），即函数的local变量每次都重新初始化，上一次被调用的状态丢失</li>
<li>return返回控制权给caller,除非再次调用，控制权不会回来。</li>
</ol>
<p>而在有些情况下，我们希望的函数可以：yield一些值，也即函数暂时交出控制权给caller,你暂时不要销毁我的本地变量一些状态，因为将来还需要caller返回控制权，我可以继续执行下去。这就是yield以及生成器的设计初衷。</p>
<a id="more"></a>
<p>generator需要负责两件事：</p>
<ol>
<li>向一个正常函数一行生成并返回值</li>
<li>保存并恢复自己在交出控制权前一刻的内部‘状态’</li>
</ol>
<p>正常的函数可以理解为subroutine,而generator可以理解为<a href="http://en.wikipedia.org/wiki/Coroutine" target="_blank" rel="external">coroutine</a>。但是python从语言层面并没有定义协程的概念。</p>
<h3 id="u4EC0_u4E48_u662Fgenerator"><a href="#u4EC0_u4E48_u662Fgenerator" class="headerlink" title="什么是generator"></a>什么是generator</h3><ol>
<li>generator就是一种迭代器（iterator)，满足迭代器的基本特性，即generator每次执行的时候只会生成一个value, 而不是全部生成</li>
<li>generator function是含有yield的function, 由它产生的迭代器叫做generator.</li>
<li>generator在返回值的时候使用yield，下次执行的时候从yield下一行开始执行，函数的上一次执行状态依然保留。</li>
<li>generator使用了与iterator相同的内建函数<code>next()</code>来获取下一个值，而next()又负责调用generator的<code>__next__()</code>。(这里可理解为python自动将带有yield的函数做了封装，使其成为了iterator) for循环隐式调用了next(generator)</li>
</ol>
<h3 id="u4EC0_u4E48_u662F_u8FED_u4EE3_u5668iterator_2C_u4EE5_u53CAiterable_u7C7B_u578B"><a href="#u4EC0_u4E48_u662F_u8FED_u4EE3_u5668iterator_2C_u4EE5_u53CAiterable_u7C7B_u578B" class="headerlink" title="什么是迭代器iterator,以及iterable类型"></a>什么是迭代器iterator,以及iterable类型</h3><ul>
<li>凡是可作用于for循环的对象都是Iterable类型；</li>
<li>凡是可作用于next()函数的对象都是Iterator类型，它们表示一个惰性计算的序列；</li>
</ul>
<p>因此：</p>
<ol>
<li>list、dict、str等是Iterable但不是Iterator（因为没有next()函数，并且序列创建时就已知），不过可以通过iter()函数获得一个Iterator对象<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Iterator</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line">isinstance((x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">10</span>)), Iterator)  <span class="comment"># True</span></span><br><span class="line">isinstance([], Iterator)  <span class="comment"># False</span></span><br><span class="line">isinstance(&#123;&#125;, Iterator)  <span class="comment"># False</span></span><br><span class="line">isinstance(iter([]), Iterator)  <span class="comment"># True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 因为itertools.permutations生成的Permutations对象定义了`__next__()`函数和`__iter__()`函数，所以它具备Iterator的特性</span></span><br><span class="line">l = [x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">10</span>)]</span><br><span class="line">ll = itertools.permutations(l)</span><br><span class="line">isinstance(ll, Iterator)   <span class="comment"># True</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="python_generator_u7684_u51E0_u70B9_u6CE8_u610F"><a href="#python_generator_u7684_u51E0_u70B9_u6CE8_u610F" class="headerlink" title="python generator的几点注意"></a>python generator的几点注意</h3><ol>
<li>generator和generator function不同，g function是定义，generator是generator function的一个实例，一个g function可以根据参数的不同生成不同的generator，即使参数相同，产生的也是不同的generator实例。</li>
<li>generator只能迭代一次，再次迭代需要重新生成实例；并且只能向前迭代。</li>
<li>generator中可以有return语句，遇到return,则generator直接抛出StopItreation异常，结束迭代过程</li>
</ol>
<h3 id="u5982_u4F55_u521B_u5EFAgenerator"><a href="#u5982_u4F55_u521B_u5EFAgenerator" class="headerlink" title="如何创建generator"></a>如何创建generator</h3><ol>
<li><p>使用yield定义函数，然后用函数生成一个或多个generator实例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fibs</span><span class="params">(iterations)</span>:</span></span><br><span class="line">    n, a, b = <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> n &lt; iterations:</span><br><span class="line">        <span class="keyword">yield</span> b</span><br><span class="line">        a, b = b, a+b</span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> fibs(<span class="number">10</span>):</span><br><span class="line">    print(i)</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用生成器表达式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">g = (x*x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">4</span>))</span><br><span class="line">print(g) <span class="comment"># &lt;generator object &lt;genexpr&gt; at 0x101b35288&gt;</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> g:</span><br><span class="line">    print(x)  <span class="comment"># 只能迭代一次</span></span><br><span class="line">print(isinstance(g, types.GeneratorType))  <span class="comment"># True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意区分：生成器是不会直接算出所有结果的，而列表生成式则会直接计算所有结果，并且输出</span></span><br><span class="line">l = [x*x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">4</span>)]</span><br><span class="line">print(l) <span class="comment"># [0, 1, 4, 9]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意区分： 用itertools可以将一个列表迭代器化，但通常这样做没有意义。当然，itertools可以用于复制，合并迭代器等，这些功能就比较有用了</span></span><br><span class="line">l = [x*x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">4</span>)]</span><br><span class="line">ll = itertools.permutations(l)</span><br><span class="line">print(ll)  <span class="comment"># &lt;itertools.permutations object at 0x1012e6a98&gt;</span></span><br><span class="line">print(list(ll))  <span class="comment"># 用list可以将迭代器的结果全都算出来</span></span><br><span class="line">print(isinstance(ll, Iterator))  <span class="comment"># True</span></span><br><span class="line">print(isinstance(ll, types.GeneratorType))  <span class="comment"># False, 并不是Generator</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="u4F7F_u7528yield_u7684_u597D_u5904"><a href="#u4F7F_u7528yield_u7684_u597D_u5904" class="headerlink" title="使用yield的好处"></a>使用yield的好处</h3><p>yield本质就是利用python内建的机制，生成一个迭代器。并且这个迭代器对应的函数的中间结果是python自动帮你维护的。简单来说，迭代器与yield的区别：</p>
<ol>
<li>迭代器需要构建类，实现相应的<code>next()</code>函数和<code>__iter__()</code>函数；而yield不需要</li>
<li>yield的中间结果由python机制保存，无需手动维护；而迭代器需要将函数功能封装为类，手动维护每次迭代的中间结果(也即手动维护<code>next()</code>函数与上一轮结果的关系)</li>
<li>迭代器本质上也是解耦了函数的计算过程和结果获取，但是其实现需要较复杂的编程维护；yield借助python的内建机制，实现了函数计算过程和结果获取的解耦。</li>
</ol>
<p>注意理解函数计算过程和结果获取的解耦。这里举个例子（来源于Python Cookbook1.3节）：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.3 保留最后的N个元素</span></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(lines, pattern, history=<span class="number">5</span>)</span>:</span></span><br><span class="line">    previous_lines = deque(maxlen=history)</span><br><span class="line">    <span class="keyword">for</span> li <span class="keyword">in</span> lines:</span><br><span class="line">        <span class="keyword">if</span> pattern <span class="keyword">in</span> li:</span><br><span class="line">            <span class="keyword">yield</span> li, previous_lines</span><br><span class="line">            <span class="comment"># 使用yield可以将搜索过程和使用搜索结果的代码解耦,</span></span><br><span class="line">            <span class="comment"># 即不需要显示指定每一步的结果存储到容器中去</span></span><br><span class="line">        previous_lines.append(li)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">r'../../cookbook/somefile.txt'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line, prevlines <span class="keyword">in</span> search(f, <span class="string">'python'</span>, <span class="number">5</span>):</span><br><span class="line">            <span class="keyword">for</span> pline <span class="keyword">in</span> prevlines:</span><br><span class="line">                print(pline, end=<span class="string">''</span>)</span><br><span class="line">            print(line, end=<span class="string">''</span>)</span><br><span class="line">            print(<span class="string">'-'</span> * <span class="number">20</span>)</span><br></pre></td></tr></table></figure></p>
<p>如果不用yield，调用search的函数就需要知道serch是如何保存结果的，map还是list还是set。当然你可以用迭代器去做，也能达到解耦的目的，但是为了解耦，迭代器需要额外定义一个类，显然增添了很多工作，不如yield来得方便。</p>
<h3 id="u4F7F_u7528yield_u7684_u573A_u666F_u548C_u4F8B_u5B50"><a href="#u4F7F_u7528yield_u7684_u573A_u666F_u548C_u4F8B_u5B50" class="headerlink" title="使用yield的场景和例子"></a>使用yield的场景和例子</h3><h4 id="u4F8B_u5B50"><a href="#u4F8B_u5B50" class="headerlink" title="例子"></a>例子</h4><p>参考文献2中提到的一个很好的例子：文件读取。如果直接对文件对象调用 read() 方法，会导致不可预测的内存占用。好的方法是利用固定长度的缓冲区来不断读取文件内容。通过 yield，我们不再需要编写读文件的迭代类，就可以轻松实现文件读取。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_file</span><span class="params">(fpath)</span>:</span> </span><br><span class="line">   BLOCK_SIZE = <span class="number">1024</span> </span><br><span class="line">   <span class="keyword">with</span> open(fpath, <span class="string">'rb'</span>) <span class="keyword">as</span> f: </span><br><span class="line">       <span class="keyword">while</span> <span class="keyword">True</span>: </span><br><span class="line">           block = f.read(BLOCK_SIZE) </span><br><span class="line">           <span class="keyword">if</span> block: </span><br><span class="line">               <span class="keyword">yield</span> block </span><br><span class="line">           <span class="keyword">else</span>: </span><br><span class="line">               <span class="keyword">return</span></span><br></pre></td></tr></table></figure></p>
<h3 id="u5141_u8BB8_u5411generator_u4F20_u9012_u53C2_u6570_uFF0C_u5E76_u4E14_u968F_u7740_u8FED_u4EE3_u6539_u53D8"><a href="#u5141_u8BB8_u5411generator_u4F20_u9012_u53C2_u6570_uFF0C_u5E76_u4E14_u968F_u7740_u8FED_u4EE3_u6539_u53D8" class="headerlink" title="允许向generator传递参数，并且随着迭代改变"></a>允许向generator传递参数，并且随着迭代改变</h3><p><a href="http://www.python.org/dev/peps/pep-0342/" target="_blank" rel="external">PEP342</a> 规定可以向generator迭代过程中传递参数，（创建时传递参数很明显可以）</p>
<p><code>other = yield number</code> 意味着，yield number, 并且当调用者send给我number，同时将other设置为number。</p>
<p><strong>原则上必须至少send一次None，至于迭代过程中是否需要send，视情况而定。有时候至少需要send一次正常值，才能保证参数不为None，从而执行不会报错。本例就是这样的情况。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_primes</span><span class="params">(number)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">if</span> is_prime(number):</span><br><span class="line">            number = <span class="keyword">yield</span> number</span><br><span class="line">        number += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_successive_primes</span><span class="params">(iterations, base=<span class="number">10</span>)</span>:</span></span><br><span class="line">    prime_generator = get_primes(base)</span><br><span class="line">    prime_generator.send(<span class="keyword">None</span>)</span><br><span class="line">    <span class="keyword">for</span> power <span class="keyword">in</span> range(iterations):</span><br><span class="line">        print(prime_generator.send(base ** power))</span><br></pre></td></tr></table></figure>
<p>这里的<code>send(None)</code>是必须的，否则会报错<code>TypeError: can&#39;t send non-None value to a just-started generator</code>。原文解释如下：</p>
<p> When you’re using send to “start” a generator (that is, execute the code from the first line of the generator function up to the first yield statement), you must send None. This makes sense, since by definition the generator hasn’t gotten to the first yield statement yet, so if we sent a real value there would be nothing to “receive” it. Once the generator is started, we can send values as we do above.</p>
<p>需要在先send一个None,让generator执行到yield的地方(实际上get_primes(base)中的base被None覆盖了)，然后第一个send的值才能被yield接受。这里的第一个send(None)相当于启动了生成器。</p>
<p><code>get_primes(base)</code>中的base被None覆盖了。经测试，将base替换为任意值都无关紧要，同时如果直接调用next(primer_generator)，则会报错：<code>Cannot use += for None and int(1)</code>，必须要send一个正常值才可以</p>
<h3 id="u66F4_u63A5_u8FD1_u73B0_u5B9E_u7684_u6848_u4F8B"><a href="#u66F4_u63A5_u8FD1_u73B0_u5B9E_u7684_u6848_u4F8B" class="headerlink" title="更接近现实的案例"></a>更接近现实的案例</h3><p>上述的例子基本在实际开发中很少写，这里给出一个更为接近实际的案例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""Return 3 random integers between 0 and 9"""</span></span><br><span class="line">    <span class="keyword">return</span> random.sample(range(<span class="number">10</span>), <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consume</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""Displays a running average across lists of integers sent to it"""</span></span><br><span class="line">    running_sum = <span class="number">0</span></span><br><span class="line">    data_items_seen = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        data = <span class="keyword">yield</span></span><br><span class="line">        data_items_seen += len(data)</span><br><span class="line">        running_sum += sum(data)</span><br><span class="line">        print(<span class="string">'The running average is &#123;&#125;'</span>.format(running_sum / float(data_items_seen)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">produce</span><span class="params">(consumer)</span>:</span></span><br><span class="line">    <span class="string">"""Produces a set of values and forwards them to the pre-defined consumer</span><br><span class="line">    function"""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        data = get_data()</span><br><span class="line">        print(<span class="string">'Produced &#123;&#125;'</span>.format(data))</span><br><span class="line">        consumer.send(data)</span><br><span class="line">        <span class="keyword">yield</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    consumer = consume()</span><br><span class="line">    consumer.send(<span class="keyword">None</span>)</span><br><span class="line">    producer = produce(consumer)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        print(<span class="string">'Producing...'</span>)</span><br><span class="line">        next(producer)</span><br></pre></td></tr></table></figure>
<h3 id="yield_u7684_u57FA_u672C_u539F_u7406"><a href="#yield_u7684_u57FA_u672C_u539F_u7406" class="headerlink" title="yield的基本原理"></a>yield的基本原理</h3><p>假设generator: g和调用g的函数caller,主要的流程：</p>
<ul>
<li>当caller调用到next(g)的时候，执行generator function</li>
<li>执行到yield时，返回控制权给caller，同时记录g的当前状态（‘state’）</li>
<li>caller获得控制权，并使用g返回的值</li>
<li>下一次调用next(g)的时候，g恢复上一次的state，并从yield的下一行开始继续执行</li>
<li>当next(g)调用时，如果g没有可以返回的值，抛出StopIteration异常，g结束</li>
</ul>
<h3 id="u53C2_u8003"><a href="#u53C2_u8003" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="http://pyzh.readthedocs.org/en/latest/the-python-yield-keyword-explained.html" target="_blank" rel="external">http://pyzh.readthedocs.org/en/latest/the-python-yield-keyword-explained.html</a></li>
<li><a href="http://www.ibm.com/developerworks/cn/opensource/os-cn-python-yield/" target="_blank" rel="external">http://www.ibm.com/developerworks/cn/opensource/os-cn-python-yield/</a></li>
<li><a href="http://www.jeffknupp.com/blog/2013/04/07/improve-your-python-yield-and-generators-explained/" target="_blank" rel="external">Improve your python-yield and generators explained</a></li>
</ol>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/python/" rel="tag">#python</a>
          
            <a href="/tags/generator/" rel="tag">#generator</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/05/27/linux-server-command/" rel="next" title="Linux Server Commands">
                <i class="fa fa-chevron-left"></i> Linux Server Commands
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/05/27/how-to-be-more-productive/" rel="prev" title="How to be more productive(转)">
                How to be more productive(转) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


        </div>

        


        
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/05/27/Python-generator/"
           data-title="Python generator" data-url="http://paranoidq.github.io/2016/05/27/Python-generator/">
      </div>
    
  </div>


      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/avatar.jpg" alt="Paranoid Qian" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Paranoid Qian</p>
        </div>
        <p class="site-description motion-element" itemprop="description">So we beat on, boats against the current, borne back ceaselessly into the past.</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/tags/碎片/">
              <span class="site-state-item-count">61</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">22</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">62</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/paranoidq" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/2094289700/profile?topnav=1&wvr=6&is_all=1" target="_blank">
                  
                    <i class="fa fa-globe"></i> weibo
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">友情链接</p>
            
              <span class="links-of-author-item">
                <a href="http://macshuo.com/" target="_blank">MacTalk</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.hollischuang.com/" target="_blank">HollisChuang</a>
              </span>
            
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#python_generator_u7684_u8BBE_u8BA1_u8003_u8651"><span class="nav-number">1.</span> <span class="nav-text">python generator的设计考虑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u4EC0_u4E48_u662Fgenerator"><span class="nav-number">2.</span> <span class="nav-text">什么是generator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u4EC0_u4E48_u662F_u8FED_u4EE3_u5668iterator_2C_u4EE5_u53CAiterable_u7C7B_u578B"><span class="nav-number">3.</span> <span class="nav-text">什么是迭代器iterator,以及iterable类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#python_generator_u7684_u51E0_u70B9_u6CE8_u610F"><span class="nav-number">4.</span> <span class="nav-text">python generator的几点注意</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u5982_u4F55_u521B_u5EFAgenerator"><span class="nav-number">5.</span> <span class="nav-text">如何创建generator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u4F7F_u7528yield_u7684_u597D_u5904"><span class="nav-number">6.</span> <span class="nav-text">使用yield的好处</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u4F7F_u7528yield_u7684_u573A_u666F_u548C_u4F8B_u5B50"><span class="nav-number">7.</span> <span class="nav-text">使用yield的场景和例子</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#u4F8B_u5B50"><span class="nav-number">7.1.</span> <span class="nav-text">例子</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u5141_u8BB8_u5411generator_u4F20_u9012_u53C2_u6570_uFF0C_u5E76_u4E14_u968F_u7740_u8FED_u4EE3_u6539_u53D8"><span class="nav-number">8.</span> <span class="nav-text">允许向generator传递参数，并且随着迭代改变</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u66F4_u63A5_u8FD1_u73B0_u5B9E_u7684_u6848_u4F8B"><span class="nav-number">9.</span> <span class="nav-text">更接近现实的案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#yield_u7684_u57FA_u672C_u539F_u7406"><span class="nav-number">10.</span> <span class="nav-text">yield的基本原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u53C2_u8003"><span class="nav-number">11.</span> <span class="nav-text">参考</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Paranoid Qian</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"paranoidq"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.2" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    motionMiddleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');
      if (CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    };
  });
</script>



  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  
  

</body>
</html>
