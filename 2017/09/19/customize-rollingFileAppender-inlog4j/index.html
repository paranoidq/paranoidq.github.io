<!doctype html>
<html class="theme-next ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="log4j,RollingFileAppender," />





  <link rel="alternate" href="/atom.xml" title="钱唯の个人博客" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="场景描述在开发中，一直使用的RollingFileAppender，但是存在几个问题：  这个appender是按照序号作为后缀来命名日志文件的，生产中日志较为频繁的情况下，根据发生时间定位问题日志需要全局grep，耗费时间并且对业务运行有一定的影响。 rolling的时候会统一将所有已经存在的日志文件序号向后偏移，即原来是test.log、test.log.1，现在变成了test.log(新建的">
<meta name="keywords" content="log4j,RollingFileAppender">
<meta property="og:type" content="article">
<meta property="og:title" content="定制log4j中的RollingFileAppender">
<meta property="og:url" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/index.html">
<meta property="og:site_name" content="钱唯の个人博客">
<meta property="og:description" content="场景描述在开发中，一直使用的RollingFileAppender，但是存在几个问题：  这个appender是按照序号作为后缀来命名日志文件的，生产中日志较为频繁的情况下，根据发生时间定位问题日志需要全局grep，耗费时间并且对业务运行有一定的影响。 rolling的时候会统一将所有已经存在的日志文件序号向后偏移，即原来是test.log、test.log.1，现在变成了test.log(新建的">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505974901991.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505977815526.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505977927393.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505978561742.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505979707309.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505979635748.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505983702826.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505983775100.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505983997060.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505984141490.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505984762810.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505984287906.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505984327046.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505984569244.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505984638152.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505984799252.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505984937102.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505984980844.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505985230417.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505985546690.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505985904866.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505986408250.png">
<meta property="og:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505986360244.png">
<meta property="og:updated_time" content="2017-09-21T10:20:37.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="定制log4j中的RollingFileAppender">
<meta name="twitter:description" content="场景描述在开发中，一直使用的RollingFileAppender，但是存在几个问题：  这个appender是按照序号作为后缀来命名日志文件的，生产中日志较为频繁的情况下，根据发生时间定位问题日志需要全局grep，耗费时间并且对业务运行有一定的影响。 rolling的时候会统一将所有已经存在的日志文件序号向后偏移，即原来是test.log、test.log.1，现在变成了test.log(新建的">
<meta name="twitter:image" content="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/1505974901991.png">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'always',
    motion: false
  };
</script>

  <title> 定制log4j中的RollingFileAppender | 钱唯の个人博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">钱唯の个人博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">佳思忽来，书能下酒；侠情一往，云可赠人。</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tops">
          <a href="/tags/top/" rel="section">
            
              <i class="menu-item-icon fa fa-收藏 fa-fw"></i> <br />
            
            收藏
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/tags/碎片/" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            碎片
          </a>
        </li>
      
        
        <li class="menu-item menu-item-todo">
          <a href="/tags/todo/" rel="section">
            
              <i class="menu-item-icon fa fa-TODO fa-fw"></i> <br />
            
            待办
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                定制log4j中的RollingFileAppender
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            更新于
            <time itemprop="dateCreated" datetime="2017-09-19T17:22:04+08:00" content="2017-09-19">
              2017-09-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/log4j/" itemprop="url" rel="index">
                    <span itemprop="name">log4j</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/09/19/customize-rollingFileAppender-inlog4j/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/09/19/customize-rollingFileAppender-inlog4j/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><h2 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h2><p>在开发中，一直使用的<code>RollingFileAppender</code>，但是存在几个问题：</p>
<ul>
<li>这个appender是按照序号作为后缀来命名日志文件的，生产中日志较为频繁的情况下，根据发生时间定位问题日志需要全局grep，耗费时间并且对业务运行有一定的影响。</li>
<li>rolling的时候会统一将所有已经存在的日志文件序号向后偏移，即原来是<code>test.log、test.log.1</code>，现在变成了<code>test.log(新建的空文件)、test.log.1、test.log.2</code>。这就导致可能之前查找的问题日志在<code>test.log.1</code>中，现在跑到<code>test.log.2</code>里面去了，那么想要保存日志以备后续分析就容易搞错。</li>
</ul>
<p>因此为了解决上面的问题，决定采用下面的逻辑：</p>
<ul>
<li>一旦日志满了，被backUp了，就不再改变文件名了，保持内容和文件名不动</li>
<li>用backUp的时间节点作为后缀，这样可以比较容易地根据时间来到对应的日志文件中查找，不需要全局grep了。</li>
</ul>
<p>显然，需要对<code>RollingFileAppender</code>进行定制，更改其中的rollOver的逻辑。</p>
<h2 id="具体方案"><a href="#具体方案" class="headerlink" title="具体方案"></a>具体方案</h2><p>RollingFileAppender继承与FIleAppender，内部函数包括：<br><img src="./1505974901991.png" alt="Alt text"></p>
<p>大致可以知道，其实就是要修改<code>rollOver()</code>函数的逻辑。我们先看原有<code>rollOver()</code>函数相关的代码：</p>
<p><code>subAppend</code>函数在当前文件写满之后，会调用rollOver函数，进行“滚动”操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subAppend</span><span class="params">(LoggingEvent event)</span> </span>&#123;</div><div class="line">	<span class="keyword">super</span>.subAppend(event);</div><div class="line">	<span class="keyword">if</span>(fileName != <span class="keyword">null</span> &amp;&amp; qw != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">long</span> size = ((CountingQuietWriter) qw).getCount();</div><div class="line">		<span class="keyword">if</span> (size &gt;= maxFileSize &amp;&amp; size &gt;= nextRollover) &#123;</div><div class="line">		   rollOver();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>rollOver</code>函数做了几个事情：</p>
<ol>
<li>首先确保maxBackups值大于0，如果小于等于0则没有必要做滚动，直接重置当前文件即可；检查是否超过maxBackup值，超过了则删除最旧的日志备份文件，这个最旧的文件文件名是<code>fileName.maxBackupInex</code>。</li>
<li>对当前已经存在的backUp后缀名进行逐个偏移，例如<code>test.log.1</code>变为<code>test.log.2</code>。</li>
<li>将当前文件重命名为<code>test.log.1</code>，如果重命名没有成功，则恢复fileName为当前文件名，还是继续往后写。</li>
<li>如果前面的重命名都成功了，那么关闭当前文件，系统在下次写日志时会重建一个新的空日志文件作为写入目标。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="comment">// synchronization not necessary since doAppend is alreasy synched</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">rollOver</span><span class="params">()</span> </span>&#123;</div><div class="line">	File target;</div><div class="line">    File file;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (qw != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">long</span> size = ((CountingQuietWriter) qw).getCount();</div><div class="line">        LogLog.debug(<span class="string">"rolling over count="</span> + size);</div><div class="line">        <span class="comment">//   if operation fails, do not roll again until</span></div><div class="line">        <span class="comment">//      maxFileSize more bytes are written</span></div><div class="line">        nextRollover = size + maxFileSize;</div><div class="line">    &#125;</div><div class="line">    LogLog.debug(<span class="string">"maxBackupIndex="</span>+maxBackupIndex);</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> renameSucceeded = <span class="keyword">true</span>;</div><div class="line">    <span class="comment">// If maxBackups &lt;= 0, then there is no file renaming to be done.</span></div><div class="line">    <span class="keyword">if</span>(maxBackupIndex &gt; <span class="number">0</span>) &#123;</div><div class="line">	    ① ······················································</div><div class="line">	    <span class="comment">// Delete the oldest file, to keep Windows happy.</span></div><div class="line">	    file = <span class="keyword">new</span> File(fileName + <span class="string">'.'</span> + maxBackupIndex);</div><div class="line">		<span class="keyword">if</span> (file.exists())</div><div class="line">		    renameSucceeded = file.delete();</div><div class="line"></div><div class="line">		② ······················································</div><div class="line">	    <span class="comment">// Map &#123;(maxBackupIndex - 1), ..., 2, 1&#125; to &#123;maxBackupIndex, ..., 3, 2&#125;</span></div><div class="line">	    <span class="keyword">for</span> (<span class="keyword">int</span> i = maxBackupIndex - <span class="number">1</span>; i &gt;= <span class="number">1</span> &amp;&amp; renameSucceeded; i--) &#123;</div><div class="line">		    file = <span class="keyword">new</span> File(fileName + <span class="string">"."</span> + i);</div><div class="line">			<span class="keyword">if</span> (file.exists()) &#123;</div><div class="line">				  target = <span class="keyword">new</span> File(fileName + <span class="string">'.'</span> + (i + <span class="number">1</span>));</div><div class="line">				  LogLog.debug(<span class="string">"Renaming file "</span> + file + <span class="string">" to "</span> + target);</div><div class="line">				  renameSucceeded = file.renameTo(target);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	    ③ ······················································</div><div class="line">	    <span class="keyword">if</span>(renameSucceeded) &#123;</div><div class="line">	        <span class="comment">// Rename fileName to fileName.1</span></div><div class="line">            target = <span class="keyword">new</span> File(fileName + <span class="string">"."</span> + <span class="number">1</span>);</div><div class="line"></div><div class="line">	        <span class="keyword">this</span>.closeFile(); <span class="comment">// keep windows happy.</span></div><div class="line"></div><div class="line">	        file = <span class="keyword">new</span> File(fileName);</div><div class="line">	        LogLog.debug(<span class="string">"Renaming file "</span> + file + <span class="string">" to "</span> + target);</div><div class="line">	        renameSucceeded = file.renameTo(target);</div><div class="line">	        <span class="comment">//</span></div><div class="line">	        <span class="comment">//   if file rename failed, reopen file with append = true</span></div><div class="line">	        <span class="comment">//</span></div><div class="line">            <span class="keyword">if</span> (!renameSucceeded) &#123;</div><div class="line">		        <span class="keyword">try</span> &#123;</div><div class="line">		            <span class="keyword">this</span>.setFile(fileName, <span class="keyword">true</span>, bufferedIO, bufferSize);</div><div class="line">		        &#125; <span class="keyword">catch</span>(IOException e) &#123;</div><div class="line">	                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> InterruptedIOException) &#123;</div><div class="line">	                    Thread.currentThread().interrupt();</div><div class="line">	                &#125;</div><div class="line">	                LogLog.error(<span class="string">"setFile("</span>+fileName+<span class="string">", true) call failed."</span>, e);</div><div class="line">	            &#125;</div><div class="line">	        &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">//   if all renames were successful, then</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    ④ ······················································</div><div class="line">    <span class="keyword">if</span> (renameSucceeded) &#123;</div><div class="line">	    <span class="keyword">try</span> &#123;</div><div class="line">	      <span class="comment">// This will also close the file. This is OK since multiple</span></div><div class="line">	      <span class="comment">// close operations are safe.</span></div><div class="line">	        <span class="keyword">this</span>.setFile(fileName, <span class="keyword">false</span>, bufferedIO, bufferSize);</div><div class="line">	        nextRollover = <span class="number">0</span>;</div><div class="line">	     &#125; <span class="keyword">catch</span>(IOException e) &#123;</div><div class="line">	         <span class="keyword">if</span> (e <span class="keyword">instanceof</span> InterruptedIOException) &#123;</div><div class="line">	             Thread.currentThread().interrupt();</div><div class="line">	         &#125;</div><div class="line">             LogLog.error(<span class="string">"setFile("</span>+fileName+<span class="string">", false) call failed."</span>, e);</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>根据以上的逻辑我们修改rollOver函数中的文件命名规则，在重命名时采用当前时间作为后缀即可。但是，还有一个问题需要解决：<code>如何判定最旧的文件名字</code>。显然，<code>RollingFileAppender</code>以序号作为后缀是很简单的，直接找最大序号即可；但是如果用时间作为后缀就需要做一些额外的处理。这里有两种思路：</p>
<ul>
<li>按照后缀排序</li>
<li>将文件名存在一个FILO队列中，每次需要删除的时候取出队首的文件名进行删除</li>
</ul>
<p>第二种思路相对比较简单，因此我采用了第二种方式。在实现过程中，还需要解决一个问题，一旦系统重启，FILO队列将丢失，如果不保存FILO队列到磁盘，那么下次系统启动的时候就无法知道已经有了哪些backUp日志文件，FILO就失去了作用，每次系统重启就会导致日志备份文件增长一倍。因此还需要做的一件事情是：</p>
<ul>
<li>在改变FILO队列之后，立马将其序列化到磁盘中；然后在<code>Logger</code>初始化的时候加载FILO队列。这样可以还原系统之前的<code>Logger</code>备份文件的所有名称，当达到<code>maxBackUpIndex</code>的时候就能够正确找到文件名进行删除了。</li>
</ul>
<p>基本的实现思路介绍完了，下面是修改的代码：</p>
<p>首先需要定义两个变量，一个是FILO队列，另一个是序列化FILO队列到磁盘时的文件后缀名，注意要与日志备份文件区分开。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 序列化existedLogFileNames队列的文件名后缀</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERIALIZE_POSTFIX = <span class="string">".restore"</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 存储backUp的文件名</span></div><div class="line"><span class="comment"> * existedLogFileNames.capacity == maxBackUp</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> LinkedBlockingDeque&lt;String&gt; existedLogFileNames;</div></pre></td></tr></table></figure></p>
<p>然后定义一个函数，用当前时间和原始文件名构造新的backup文件名：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 将当前的日志文件重命名为backUp文件</span></div><div class="line"><span class="comment"> * 以当前时间作为后缀，方便查找</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">renameAsBackup</span><span class="params">()</span> </span>&#123;</div><div class="line">    SimpleDateFormat format = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd_HHmmss_SSS"</span>);</div><div class="line">    String dateString = format.format(<span class="keyword">new</span> Date(System.currentTimeMillis()));</div><div class="line">    <span class="keyword">return</span> fileName + <span class="string">"."</span> + dateString;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后我们改写rollOver函数：</p>
<ol>
<li>删除文件的时候，从FILO队列中poll头部文件名删除</li>
<li>移除了滚动重命名的部分代码，只需要将当前已满的日志文件重命名，重命名的名字由<code>renameBackup()</code>函数根据当前时间来构造</li>
<li>重命名成功之后，将重命名后的文件放入FILO队列中，同时立即序列化FILO队列到磁盘<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="comment">// synchronization not necessary since doAppend is alreasy synched</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">rollOver</span><span class="params">()</span> </span>&#123;</div><div class="line">    LogLog.debug(<span class="string">"当前队列剩余空间: "</span> + existedLogFileNames.remainingCapacity());</div><div class="line">    System.out.println(<span class="string">"当前队列剩余空间: "</span> + existedLogFileNames.remainingCapacity());</div><div class="line"></div><div class="line">    File file;</div><div class="line">    <span class="keyword">if</span> (qw != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">long</span> size = ((CountingQuietWriter) qw).getCount();</div><div class="line">        LogLog.debug(<span class="string">"rolling over count="</span> + size);</div><div class="line">        <span class="comment">//   if operation fails, do not roll again until</span></div><div class="line">        <span class="comment">//      maxFileSize more bytes are written</span></div><div class="line">        nextRollover = size + maxFileSize;</div><div class="line">    &#125;</div><div class="line">    LogLog.debug(<span class="string">"maxBackupIndex="</span>+maxBackupIndex);</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> deleteSuccess = <span class="keyword">true</span>;</div><div class="line">    <span class="comment">// If maxBackups &lt;= 0, then there is no file renaming to be done.</span></div><div class="line">    <span class="keyword">if</span>(maxBackupIndex &gt; <span class="number">0</span> &amp;&amp; existedLogFileNames.size() &gt;= maxBackupIndex) &#123;</div><div class="line">        <span class="comment">// Delete the oldest file, to keep Windows happy.</span></div><div class="line">        ① ······················································</div><div class="line">        file = <span class="keyword">new</span> File(existedLogFileNames.pollFirst());</div><div class="line">        <span class="keyword">if</span> (file.exists()) &#123;</div><div class="line">            deleteSuccess = file.delete();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> renameSuccess = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">if</span> (deleteSuccess) &#123;</div><div class="line">    ② ······················································</div><div class="line">        <span class="comment">// 将当前日志文件backUp重命名</span></div><div class="line">        File target = <span class="keyword">new</span> File(renameAsBackup());</div><div class="line">        <span class="keyword">this</span>.closeFile();</div><div class="line">        file = <span class="keyword">new</span> File(fileName);</div><div class="line">        LogLog.debug(<span class="string">"Renaming file "</span> + file + <span class="string">" to "</span> + target);</div><div class="line">        renameSuccess = file.renameTo(target);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (renameSuccess) &#123;</div><div class="line">            <span class="comment">// 将重命名后的文件名存入FILO队列</span></div><div class="line">            ③ ······················································</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                renameSuccess = existedLogFileNames.offerLast(target.getCanonicalPath());</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                renameSuccess = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (renameSuccess) &#123;</div><div class="line">                <span class="comment">// 将FILO队列序列化到磁盘，以便系统重启时读取</span></div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    File f = <span class="keyword">new</span> File(fileName + SERIALIZE_POSTFIX);</div><div class="line">                    f.createNewFile();</div><div class="line">                    SerializationUtils.serialize(existedLogFileNames, <span class="keyword">new</span> FileOutputStream(f, <span class="keyword">false</span>));</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                    LogLog.debug(<span class="string">"Error serialize existed file queue"</span>, e);</div><div class="line">                    renameSuccess = <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//</span></div><div class="line">        <span class="comment">//   if file rename failed, reopen file with append = true</span></div><div class="line">        <span class="comment">//</span></div><div class="line">        <span class="keyword">if</span> (!renameSuccess) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">this</span>.setFile(fileName, <span class="keyword">true</span>, bufferedIO, bufferSize);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">catch</span>(IOException e) &#123;</div><div class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> InterruptedIOException) &#123;</div><div class="line">                    Thread.currentThread().interrupt();</div><div class="line">                &#125;</div><div class="line">                LogLog.error(<span class="string">"setFile("</span>+fileName+<span class="string">", true) call failed."</span>, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">//   if deletes were successful, then</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="keyword">if</span> (renameSuccess) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// This will also close the file. This is OK since multiple</span></div><div class="line">            <span class="comment">// close operations are safe.</span></div><div class="line">            <span class="keyword">this</span>.setFile(fileName, <span class="keyword">false</span>, bufferedIO, bufferSize);</div><div class="line">            nextRollover = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">catch</span>(IOException e) &#123;</div><div class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> InterruptedIOException) &#123;</div><div class="line">                Thread.currentThread().interrupt();</div><div class="line">            &#125;</div><div class="line">            LogLog.error(<span class="string">"setFile("</span>+fileName+<span class="string">", false) call failed."</span>, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>rollOver的逻辑写完了，还需要添加Logger初始化时从磁盘加载FILO队列的逻辑。首先将这段逻辑封装为一个函数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">restoreBackUpsIfNull</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (existedLogFileNames == <span class="keyword">null</span>) &#123;</div><div class="line">        existedLogFileNames = <span class="keyword">new</span> LinkedBlockingDeque&lt;String&gt;(getMaxBackupIndex());</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            LinkedBlockingDeque&lt;String&gt; restore = (LinkedBlockingDeque&lt;String&gt;) SerializationUtils.deserialize(</div><div class="line">                <span class="keyword">new</span> FileInputStream(fileName + SERIALIZE_POSTFIX));</div><div class="line">            existedLogFileNames.addAll(restore);</div><div class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后通过debug可以发现Logger初始化的时候会调用<code>setMaxBackUpIndex()</code>来将配置文件的值设置进来，因此重写<code>setMaxBackUpIndex()</code>函数，添加加载FILO队列的逻辑：（<strong>这种写法实际上是存在BUG的，后面会分析到</strong>）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMaxBackupIndex</span><span class="params">(<span class="keyword">int</span> maxBackups)</span> </span>&#123;</div><div class="line">     <span class="keyword">this</span>.maxBackupIndex = maxBackups;</div><div class="line">     restoreBackUpsIfNull();</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>以上就是定制<code>RollingFileAppender</code>的整个思路。</p>
<h2 id="运行测试及BUG出现"><a href="#运行测试及BUG出现" class="headerlink" title="运行测试及BUG出现"></a>运行测试及BUG出现</h2><p><code>log4j.properties</code>配置文件如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">log4j.<span class="attribute">rootLogger</span>=DEBUG</div><div class="line">log4j.logger.me.<span class="attribute">zex</span>=DEBUG, file</div><div class="line">log4j.logger.org.<span class="attribute">log4j</span>=DEBUG, console</div><div class="line"></div><div class="line">log4j.appender.<span class="attribute">console</span>=org.apache.log4j.ConsoleAppender</div><div class="line">log4j.appender.console.<span class="attribute">threshold</span>=INFO</div><div class="line">log4j.appender.console.<span class="attribute">layout</span>=org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.console.layout.<span class="attribute">ConversionPattern</span>=%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%5p] - %c -%F(%L) -%m%n</div><div class="line"></div><div class="line">log4j.appender.<span class="attribute">file</span>=me.zex.util.logger.namedLogger.NamedRollingFileAppender</div><div class="line">log4j.appender.file.<span class="attribute">File</span>=/Users/paranoidq/test/test.log</div><div class="line">log4j.appender.file.<span class="attribute">layout</span>=org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.file.layout.<span class="attribute">ConversionPattern</span>=%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%5p] - %c -%F(%L) -%m%n</div><div class="line">log4j.appender.file.<span class="attribute">MaxFileSize</span>=2KB</div><div class="line">log4j.appender.file.<span class="attribute">MaxBackupIndex</span>=10</div></pre></td></tr></table></figure></p>
<p>运行测试代码，包括了单线程写和多线程写：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> org.apache.log4j.Logger logger = org.apache.log4j.Logger.getLogger(Test.class);</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"><span class="comment">//        normalTest();</span></div><div class="line">        parallelTest();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">normalTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            logger.info(<span class="string">"test"</span>);</div><div class="line">            Thread.sleep(<span class="number">100</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parallelTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2000</span>; i++) &#123;</div><div class="line">            <span class="keyword">int</span> finalI = i;</div><div class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        latch.await();</div><div class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">1</span>; j++) &#123;</div><div class="line">                            logger.info(<span class="string">"Thread-"</span> + finalI + <span class="string">": test log "</span> + j);</div><div class="line"><span class="comment">//                            Thread.sleep(2000);</span></div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;).start();</div><div class="line">        &#125;</div><div class="line">        latch.countDown();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>测试通过，能够正常写文件和删除文件。重启之后也没问题。<br><img src="./1505977815526.png" alt="Alt text"></p>
<p>但是在同事测试的时候却发现重启之后无法加载FILO队列，在加载FILO队列时抛出<code>FileNotFoundException</code>：<br><img src="./1505977927393.png" alt="Alt text"><br>从报错信息可以看出，在<code>setMaxBackUpIndex()</code>中调用<code>restoreBackUpsIfNull()</code>获取的fileName为null。经过一系列的排查，最终定位到同事配置文件的写法与我不同：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">log4j.<span class="attribute">rootLogger</span>=DEBUG</div><div class="line">log4j.logger.me.<span class="attribute">zex</span>=DEBUG, FILE</div><div class="line">log4j.logger.org.<span class="attribute">log4j</span>=DEBUG, console</div><div class="line"></div><div class="line">log4j.appender.<span class="attribute">console</span>=org.apache.log4j.ConsoleAppender</div><div class="line">log4j.appender.console.<span class="attribute">threshold</span>=INFO</div><div class="line">log4j.appender.console.<span class="attribute">layout</span>=org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.console.layout.<span class="attribute">ConversionPattern</span>=%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%5p] - %c -%F(%L) -%m%n</div><div class="line"></div><div class="line">log4j.appender.<span class="attribute">FILE</span>=me.zex.util.logger.namedLogger.NamedRollingFileAppender</div><div class="line">log4j.appender.FILE.<span class="attribute">File</span>=/Users/paranoidq/test/test.log</div><div class="line">log4j.appender.FILE.<span class="attribute">layout</span>=org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.FILE.layout.<span class="attribute">ConversionPattern</span>=%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%5p] - %c -%F(%L) -%m%n</div><div class="line">log4j.appender.FILE.<span class="attribute">MaxFileSize</span>=2KB</div><div class="line">log4j.appender.FILE.<span class="attribute">MaxBackupIndex</span>=10</div></pre></td></tr></table></figure></p>
<p>我的配置是<code>log4j.appender.file</code>，而他的配置则是<code>log4j.appender.FILE</code>。难道仅仅是大小写的不同就造成了log4j在执行时的差别么？我又重新将<code>log4j.appender</code>改为了其他大写的名字，例如<code>XXX</code>，<code>DDD</code>，诡异的问题出现了，某些大写名称是可以正常读到<code>fileName</code>的，但是某些大写名称读到的<code>fileName</code>就为空。于是，为了解决这个BUG，我决定从源码入手，搞清楚log4j在加载Logger时的初始化流程。</p>
<h2 id="源码级别的问题定位"><a href="#源码级别的问题定位" class="headerlink" title="源码级别的问题定位"></a>源码级别的问题定位</h2><p>通过断点一步步进行debug，log4j加载Logger的大致流程如下：</p>
<h5 id="1-Logger调用LoggerManager-getLogger-clazz-getName-："><a href="#1-Logger调用LoggerManager-getLogger-clazz-getName-：" class="headerlink" title="1. Logger调用LoggerManager.getLogger(clazz.getName())："></a>1. <code>Logger</code>调用<code>LoggerManager.getLogger(clazz.getName())</code>：</h5><p><img src="./1505978561742.png" alt="Alt text"></p>
<h5 id="2-LoggerManager中会从LoggerRepository中根据名称获取Logger"><a href="#2-LoggerManager中会从LoggerRepository中根据名称获取Logger" class="headerlink" title="2. LoggerManager中会从LoggerRepository中根据名称获取Logger"></a>2. <code>LoggerManager</code>中会从<code>LoggerRepository</code>中根据名称获取Logger</h5><p><img src="./1505979707309.png" alt="Alt text"><br>而这个LoggerRepository则是在LoggerManager的static初始化块中进行一系列的初始化工作的。那么继续定位static初始化块。</p>
<h5 id="3-初始化块做了几件事情："><a href="#3-初始化块做了几件事情：" class="headerlink" title="3. 初始化块做了几件事情："></a>3. 初始化块做了几件事情：</h5><ol>
<li>首选构造了一个<code>Hirarchy</code>对象，这个对象用于表示<code>Logger</code>之间的层级关系</li>
<li>然后依次检查<code>log4j.configuration</code>是否配置、<code>log4j.xml</code>配置和<code>log4j.properties</code>配置文件，如果有就利用Loader加载。</li>
<li>加载完成后，通过<code>OptionConverter.selectAndConfigure()</code>函数进行初始化工作。显然，下一步我们需要到这个函数中取一探究竟。<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> &#123;</div><div class="line">    <span class="comment">// By default we use a DefaultRepositorySelector which always returns 'h'.</span></div><div class="line">    Hierarchy h = <span class="keyword">new</span> Hierarchy(<span class="keyword">new</span> RootLogger((Level) Level.DEBUG));</div><div class="line">    repositorySelector = <span class="keyword">new</span> DefaultRepositorySelector(h);</div><div class="line"></div><div class="line">    <span class="comment">/** Search for the properties file log4j.properties in the CLASSPATH.  */</span></div><div class="line">    String override =OptionConverter.getSystemProperty(DEFAULT_INIT_OVERRIDE_KEY,</div><div class="line">						       <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="comment">// if there is no default init override, then get the resource</span></div><div class="line">    <span class="comment">// specified by the user or the default config file.</span></div><div class="line">    <span class="keyword">if</span>(override == <span class="keyword">null</span> || <span class="string">"false"</span>.equalsIgnoreCase(override)) &#123;</div><div class="line"></div><div class="line">      String configurationOptionStr = OptionConverter.getSystemProperty(</div><div class="line">							  DEFAULT_CONFIGURATION_KEY,</div><div class="line">							  <span class="keyword">null</span>);</div><div class="line"></div><div class="line">      String configuratorClassName = OptionConverter.getSystemProperty(</div><div class="line">                                                   CONFIGURATOR_CLASS_KEY,</div><div class="line">						   <span class="keyword">null</span>);</div><div class="line"></div><div class="line">      URL url = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">      <span class="comment">// if the user has not specified the log4j.configuration</span></div><div class="line">      <span class="comment">// property, we search first for the file "log4j.xml" and then</span></div><div class="line">      <span class="comment">// "log4j.properties"</span></div><div class="line">      <span class="keyword">if</span>(configurationOptionStr == <span class="keyword">null</span>) &#123;</div><div class="line">	url = Loader.getResource(DEFAULT_XML_CONFIGURATION_FILE);</div><div class="line">	<span class="keyword">if</span>(url == <span class="keyword">null</span>) &#123;</div><div class="line">	  url = Loader.getResource(DEFAULT_CONFIGURATION_FILE);</div><div class="line">	&#125;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">	  url = <span class="keyword">new</span> URL(configurationOptionStr);</div><div class="line">	&#125; <span class="keyword">catch</span> (MalformedURLException ex) &#123;</div><div class="line">	  <span class="comment">// so, resource is not a URL:</span></div><div class="line">	  <span class="comment">// attempt to get the resource from the class path</span></div><div class="line">	  url = Loader.getResource(configurationOptionStr);</div><div class="line">	&#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// If we have a non-null url, then delegate the rest of the</span></div><div class="line">      <span class="comment">// configuration to the OptionConverter.selectAndConfigure</span></div><div class="line">      <span class="comment">// method.</span></div><div class="line">      <span class="keyword">if</span>(url != <span class="keyword">null</span>) &#123;</div><div class="line">	    LogLog.debug(<span class="string">"Using URL ["</span>+url+<span class="string">"] for automatic log4j configuration."</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            OptionConverter.selectAndConfigure(url, configuratorClassName,</div><div class="line">					   LogManager.getLoggerRepository());</div><div class="line">        &#125; <span class="keyword">catch</span> (NoClassDefFoundError e) &#123;</div><div class="line">            LogLog.warn(<span class="string">"Error during default initialization"</span>, e);</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">	    LogLog.debug(<span class="string">"Could not find resource: ["</span>+configurationOptionStr+<span class="string">"]."</span>);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        LogLog.debug(<span class="string">"Default initialization of overridden by "</span> +</div><div class="line">            DEFAULT_INIT_OVERRIDE_KEY + <span class="string">"property."</span>);</div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="4-OptionConverter"><a href="#4-OptionConverter" class="headerlink" title="4.  OptionConverter"></a>4.  OptionConverter</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">public</span></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">selectAndConfigure</span><span class="params">(URL url, String clazz, LoggerRepository hierarchy)</span> </span>&#123;</div><div class="line">   Configurator configurator = <span class="keyword">null</span>;</div><div class="line">   String filename = url.getFile();</div><div class="line"></div><div class="line">   <span class="keyword">if</span>(clazz == <span class="keyword">null</span> &amp;&amp; filename != <span class="keyword">null</span> &amp;&amp; filename.endsWith(<span class="string">".xml"</span>)) &#123;</div><div class="line">     clazz = <span class="string">"org.apache.log4j.xml.DOMConfigurator"</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">if</span>(clazz != <span class="keyword">null</span>) &#123;</div><div class="line">     LogLog.debug(<span class="string">"Preferred configurator class: "</span> + clazz);</div><div class="line">     configurator = (Configurator) instantiateByClassName(clazz,</div><div class="line">							  Configurator.class,</div><div class="line">							  <span class="keyword">null</span>);</div><div class="line">     <span class="keyword">if</span>(configurator == <span class="keyword">null</span>) &#123;</div><div class="line">   	  LogLog.error(<span class="string">"Could not instantiate configurator ["</span>+clazz+<span class="string">"]."</span>);</div><div class="line">   	  <span class="keyword">return</span>;</div><div class="line">     &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">     configurator = <span class="keyword">new</span> PropertyConfigurator();</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   configurator.doConfigure(url, hierarchy);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>在selectAndConfigure中，判断是采用哪一种<code>Configurator</code>解析配置文件，如果是xml就采用<code>org.apache.log4j.xml.DOMConfigurator</code>，如果不是，则采用<code>PropertyConfigurator</code>。为了扩展性，也可以自定义configurator来解析自定义格式的配置。最后调用<code>configurator.doConfigure(url, hierarchy)</code>进行解析。显然，这里调用的应该是<code>PropertyConfigurator.doConfigure()</code>实现。</p>
<h5 id="5-PropertyConfigurator"><a href="#5-PropertyConfigurator" class="headerlink" title="5. PropertyConfigurator"></a>5. PropertyConfigurator</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">doConfigure</span><span class="params">(Properties properties, LoggerRepository hierarchy)</span> </span>&#123;</div><div class="line">	repository = hierarchy;</div><div class="line">    String value = properties.getProperty(LogLog.DEBUG_KEY);</div><div class="line">    <span class="keyword">if</span>(value == <span class="keyword">null</span>) &#123;</div><div class="line">      value = properties.getProperty(<span class="string">"log4j.configDebug"</span>);</div><div class="line">      <span class="keyword">if</span>(value != <span class="keyword">null</span>)</div><div class="line">	LogLog.warn(<span class="string">"[log4j.configDebug] is deprecated. Use [log4j.debug] instead."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(value != <span class="keyword">null</span>) &#123;</div><div class="line">      LogLog.setInternalDebugging(OptionConverter.toBoolean(value, <span class="keyword">true</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">      <span class="comment">//</span></div><div class="line">      <span class="comment">//   if log4j.reset=true then</span></div><div class="line">      <span class="comment">//        reset hierarchy</span></div><div class="line">    String reset = properties.getProperty(RESET_KEY);</div><div class="line">    <span class="keyword">if</span> (reset != <span class="keyword">null</span> &amp;&amp; OptionConverter.toBoolean(reset, <span class="keyword">false</span>)) &#123;</div><div class="line">          hierarchy.resetConfiguration();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    String thresholdStr = OptionConverter.findAndSubst(THRESHOLD_PREFIX,</div><div class="line">						       properties);</div><div class="line">    <span class="keyword">if</span>(thresholdStr != <span class="keyword">null</span>) &#123;</div><div class="line">      hierarchy.setThreshold(OptionConverter.toLevel(thresholdStr,</div><div class="line">						     (Level) Level.ALL));</div><div class="line">      LogLog.debug(<span class="string">"Hierarchy threshold set to ["</span>+hierarchy.getThreshold()+<span class="string">"]."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    configureRootCategory(properties, hierarchy);</div><div class="line">    configureLoggerFactory(properties);</div><div class="line">    parseCatsAndRenderers(properties, hierarchy);</div><div class="line"></div><div class="line">    LogLog.debug(<span class="string">"Finished configuring."</span>);</div><div class="line">    <span class="comment">// We don't want to hold references to appenders preventing their</span></div><div class="line">    <span class="comment">// garbage collection.</span></div><div class="line">    registry.clear();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>前面的代码都是做一些debug性的工作，我们暂时忽略，关键的加载和初始化代码是三句话：<br><img src="./1505979635748.png" alt="Alt text"></p>
<h6 id="5-1-configureRootCategory"><a href="#5-1-configureRootCategory" class="headerlink" title="5.1 configureRootCategory"></a>5.1 configureRootCategory</h6><p>configureRootCategory主要负责解析根Logger相关的Category，Category在log4j中已经基本被Logger代替了。<br>这段根我们的appender没有太大的关系。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">configureRootCategory</span><span class="params">(Properties props, LoggerRepository hierarchy)</span> </span>&#123;</div><div class="line">    String effectiveFrefix = ROOT_LOGGER_PREFIX;</div><div class="line">    String value = OptionConverter.findAndSubst(ROOT_LOGGER_PREFIX, props);</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(value == <span class="keyword">null</span>) &#123;</div><div class="line">      value = OptionConverter.findAndSubst(ROOT_CATEGORY_PREFIX, props);</div><div class="line">      effectiveFrefix = ROOT_CATEGORY_PREFIX;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(value == <span class="keyword">null</span>)</div><div class="line">      LogLog.debug(<span class="string">"Could not find root logger information. Is this OK?"</span>);</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">      Logger root = hierarchy.getRootLogger();</div><div class="line">      <span class="keyword">synchronized</span>(root) &#123;</div><div class="line">	parseCategory(props, root, effectiveFrefix, INTERNAL_ROOT_NAME, value);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<h6 id="5-2-configureLoggerFactory"><a href="#5-2-configureLoggerFactory" class="headerlink" title="5.2 configureLoggerFactory"></a>5.2 configureLoggerFactory</h6><p>这段从字面意思上值用于配置自定义的Logger工厂的，与我们的Appender也没有关系。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configureLoggerFactory</span><span class="params">(Properties props)</span> </span>&#123;</div><div class="line">   String factoryClassName = OptionConverter.findAndSubst(LOGGER_FACTORY_KEY,</div><div class="line">						   props);</div><div class="line">   <span class="keyword">if</span>(factoryClassName != <span class="keyword">null</span>) &#123;</div><div class="line">     LogLog.debug(<span class="string">"Setting category factory to ["</span>+factoryClassName+<span class="string">"]."</span>);</div><div class="line">     loggerFactory = (LoggerFactory)</div><div class="line">          OptionConverter.instantiateByClassName(factoryClassName,</div><div class="line">						 LoggerFactory.class,</div><div class="line">						 loggerFactory);</div><div class="line">     PropertySetter.setProperties(loggerFactory, props, FACTORY_PREFIX + <span class="string">"."</span>);</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<h6 id="5-3-parseCatsAndRenders"><a href="#5-3-parseCatsAndRenders" class="headerlink" title="5.3 parseCatsAndRenders"></a>5.3 parseCatsAndRenders</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">parseCatsAndRenderers</span><span class="params">(Properties props, LoggerRepository hierarchy)</span> </span>&#123;</div><div class="line">    Enumeration enumeration = props.propertyNames();</div><div class="line">    <span class="keyword">while</span>(enumeration.hasMoreElements()) &#123;</div><div class="line">      String key = (String) enumeration.nextElement();</div><div class="line">      <span class="keyword">if</span>(key.startsWith(CATEGORY_PREFIX) || key.startsWith(LOGGER_PREFIX)) &#123;</div><div class="line">	String loggerName = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">if</span>(key.startsWith(CATEGORY_PREFIX)) &#123;</div><div class="line">	  loggerName = key.substring(CATEGORY_PREFIX.length());</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>(key.startsWith(LOGGER_PREFIX)) &#123;</div><div class="line">	  loggerName = key.substring(LOGGER_PREFIX.length());</div><div class="line">	&#125;</div><div class="line">	String value =  OptionConverter.findAndSubst(key, props);</div><div class="line">	Logger logger = hierarchy.getLogger(loggerName, loggerFactory);</div><div class="line">	<span class="keyword">synchronized</span>(logger) &#123;</div><div class="line">	  parseCategory(props, logger, key, loggerName, value);</div><div class="line">	  parseAdditivityForLogger(props, logger, loggerName);</div><div class="line">	&#125;</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(key.startsWith(RENDERER_PREFIX)) &#123;</div><div class="line">	String renderedClass = key.substring(RENDERER_PREFIX.length());</div><div class="line">	String renderingClass = OptionConverter.findAndSubst(key, props);</div><div class="line">	<span class="keyword">if</span>(hierarchy <span class="keyword">instanceof</span> RendererSupport) &#123;</div><div class="line">	  RendererMap.addRenderer((RendererSupport) hierarchy, renderedClass,</div><div class="line">				  renderingClass);</div><div class="line">	&#125;</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.equals(THROWABLE_RENDERER_PREFIX)) &#123;</div><div class="line">          <span class="keyword">if</span> (hierarchy <span class="keyword">instanceof</span> ThrowableRendererSupport) &#123;</div><div class="line">            ThrowableRenderer tr = (ThrowableRenderer)</div><div class="line">                  OptionConverter.instantiateByKey(props,</div><div class="line">                          THROWABLE_RENDERER_PREFIX,</div><div class="line">                          org.apache.log4j.spi.ThrowableRenderer.class,</div><div class="line">                          <span class="keyword">null</span>);</div><div class="line">            <span class="keyword">if</span>(tr == <span class="keyword">null</span>) &#123;</div><div class="line">                LogLog.error(</div><div class="line">                    <span class="string">"Could not instantiate throwableRenderer."</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                PropertySetter setter = <span class="keyword">new</span> PropertySetter(tr);</div><div class="line">                setter.setProperties(props, THROWABLE_RENDERER_PREFIX + <span class="string">"."</span>);</div><div class="line">                ((ThrowableRendererSupport) hierarchy).setThrowableRenderer(tr);</div><div class="line"></div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>这段代码主要是解析非root的配置元素<br>它首先会根据配置文件的前缀通过subString获取到loggerName：例如如果配置的是<code>log4j.logger.me.zex</code>，那么就会通过<code>loggerName = key.substring(LOGGER_PREFIX.length());</code>获取到loggerName为<code>me.zex</code>。这个loggerName会唯一确定一个Logger。<br><img src="./1505983702826.png" alt="Alt text"></p>
<p>获取Logger后，对Logger进行初始化，包括设置Category和Additivity。<br><img src="./1505983775100.png" alt="Alt text"></p>
<h6 id="5-4-parseCategory"><a href="#5-4-parseCategory" class="headerlink" title="5.4 parseCategory"></a>5.4 parseCategory</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">parseCategory</span><span class="params">(Properties props, Logger logger, String optionKey,</span></span></div><div class="line"><span class="function"><span class="params">		     String loggerName, String value)</span> </span>&#123;</div><div class="line"></div><div class="line">    LogLog.debug(<span class="string">"Parsing for ["</span> +loggerName +<span class="string">"] with value=["</span> + value+<span class="string">"]."</span>);</div><div class="line">    <span class="comment">// We must skip over ',' but not white space</span></div><div class="line">    StringTokenizer st = <span class="keyword">new</span> StringTokenizer(value, <span class="string">","</span>);</div><div class="line"></div><div class="line">    <span class="comment">// If value is not in the form ", appender.." or "", then we should set</span></div><div class="line">    <span class="comment">// the level of the loggeregory.</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span>(!(value.startsWith(<span class="string">","</span>) || value.equals(<span class="string">""</span>))) &#123;</div><div class="line"></div><div class="line">      <span class="comment">// just to be on the safe side...</span></div><div class="line">      <span class="keyword">if</span>(!st.hasMoreTokens())</div><div class="line">	<span class="keyword">return</span>;</div><div class="line"></div><div class="line">      String levelStr = st.nextToken();</div><div class="line">      LogLog.debug(<span class="string">"Level token is ["</span> + levelStr + <span class="string">"]."</span>);</div><div class="line"></div><div class="line">      <span class="comment">// If the level value is inherited, set category level value to</span></div><div class="line">      <span class="comment">// null. We also check that the user has not specified inherited for the</span></div><div class="line">      <span class="comment">// root category.</span></div><div class="line">      <span class="keyword">if</span>(INHERITED.equalsIgnoreCase(levelStr) ||</div><div class="line"> 	                                  NULL.equalsIgnoreCase(levelStr)) &#123;</div><div class="line">	<span class="keyword">if</span>(loggerName.equals(INTERNAL_ROOT_NAME)) &#123;</div><div class="line">	  LogLog.warn(<span class="string">"The root logger cannot be set to null."</span>);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">	  logger.setLevel(<span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">	logger.setLevel(OptionConverter.toLevel(levelStr, (Level) Level.DEBUG));</div><div class="line">      &#125;</div><div class="line">      LogLog.debug(<span class="string">"Category "</span> + loggerName + <span class="string">" set to "</span> + logger.getLevel());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Begin by removing all existing appenders.</span></div><div class="line">    logger.removeAllAppenders();</div><div class="line"></div><div class="line">    Appender appender;</div><div class="line">    String appenderName;</div><div class="line">    <span class="keyword">while</span>(st.hasMoreTokens()) &#123;</div><div class="line">      appenderName = st.nextToken().trim();</div><div class="line">      <span class="keyword">if</span>(appenderName == <span class="keyword">null</span> || appenderName.equals(<span class="string">","</span>))</div><div class="line">	<span class="keyword">continue</span>;</div><div class="line">      LogLog.debug(<span class="string">"Parsing appender named \""</span> + appenderName +<span class="string">"\"."</span>);</div><div class="line">      appender = parseAppender(props, appenderName);</div><div class="line">      <span class="keyword">if</span>(appender != <span class="keyword">null</span>) &#123;</div><div class="line">	logger.addAppender(appender);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>parseCategory函数会根据log4j.properties中读取的配置行提取出appender和level，并进行初始化工作。例如从<code>log4j.logger.me.zes=DEBUG, FILE</code>提取leve为<code>DEBUG</code>，而通过逗号分隔提取出appender。</p>
<p>appender的解析在parseAppender中进行，配置行中的逗号可以分隔多个appender，会因此进行解析。<br><img src="./1505983997060.png" alt="Alt text"></p>
<h6 id="5-5-parseAppender"><a href="#5-5-parseAppender" class="headerlink" title="5.5 parseAppender"></a>5.5 parseAppender</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="function">Appender <span class="title">parseAppender</span><span class="params">(Properties props, String appenderName)</span> </span>&#123;</div><div class="line">    Appender appender = registryGet(appenderName);</div><div class="line">    <span class="keyword">if</span>((appender != <span class="keyword">null</span>)) &#123;</div><div class="line">      LogLog.debug(<span class="string">"Appender \""</span> + appenderName + <span class="string">"\" was already parsed."</span>);</div><div class="line">      <span class="keyword">return</span> appender;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Appender was not previously initialized.</span></div><div class="line">    String prefix = APPENDER_PREFIX + appenderName;</div><div class="line">    String layoutPrefix = prefix + <span class="string">".layout"</span>;</div><div class="line"></div><div class="line">    appender = (Appender) OptionConverter.instantiateByKey(props, prefix,</div><div class="line">					      org.apache.log4j.Appender.class,</div><div class="line">					      <span class="keyword">null</span>);</div><div class="line">    <span class="keyword">if</span>(appender == <span class="keyword">null</span>) &#123;</div><div class="line">      LogLog.error(</div><div class="line">              <span class="string">"Could not instantiate appender named \""</span> + appenderName+<span class="string">"\"."</span>);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    appender.setName(appenderName);</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(appender <span class="keyword">instanceof</span> OptionHandler) &#123;</div><div class="line">      <span class="keyword">if</span>(appender.requiresLayout()) &#123;</div><div class="line">	Layout layout = (Layout) OptionConverter.instantiateByKey(props,</div><div class="line">								  layoutPrefix,</div><div class="line">								  Layout.class,</div><div class="line">								  <span class="keyword">null</span>);</div><div class="line">	<span class="keyword">if</span>(layout != <span class="keyword">null</span>) &#123;</div><div class="line">	  appender.setLayout(layout);</div><div class="line">	  LogLog.debug(<span class="string">"Parsing layout options for \""</span> + appenderName +<span class="string">"\"."</span>);</div><div class="line">	  <span class="comment">//configureOptionHandler(layout, layoutPrefix + ".", props);</span></div><div class="line">          PropertySetter.setProperties(layout, props, layoutPrefix + <span class="string">"."</span>);</div><div class="line">	  LogLog.debug(<span class="string">"End of parsing for \""</span> + appenderName +<span class="string">"\"."</span>);</div><div class="line">	&#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">final</span> String errorHandlerPrefix = prefix + <span class="string">".errorhandler"</span>;</div><div class="line">      String errorHandlerClass = OptionConverter.findAndSubst(errorHandlerPrefix, props);</div><div class="line">      <span class="keyword">if</span> (errorHandlerClass != <span class="keyword">null</span>) &#123;</div><div class="line">    		ErrorHandler eh = (ErrorHandler) OptionConverter.instantiateByKey(props,</div><div class="line">					  errorHandlerPrefix,</div><div class="line">					  ErrorHandler.class,</div><div class="line">					  <span class="keyword">null</span>);</div><div class="line">    		<span class="keyword">if</span> (eh != <span class="keyword">null</span>) &#123;</div><div class="line">    			  appender.setErrorHandler(eh);</div><div class="line">    			  LogLog.debug(<span class="string">"Parsing errorhandler options for \""</span> + appenderName +<span class="string">"\"."</span>);</div><div class="line">    			  parseErrorHandler(eh, errorHandlerPrefix, props, repository);</div><div class="line">    			  <span class="keyword">final</span> Properties edited = <span class="keyword">new</span> Properties();</div><div class="line">    			  <span class="keyword">final</span> String[] keys = <span class="keyword">new</span> String[] &#123;</div><div class="line">    					  errorHandlerPrefix + <span class="string">"."</span> + ROOT_REF,</div><div class="line">    					  errorHandlerPrefix + <span class="string">"."</span> + LOGGER_REF,</div><div class="line">    					  errorHandlerPrefix + <span class="string">"."</span> + APPENDER_REF_TAG</div><div class="line">    			  &#125;;</div><div class="line">    			  <span class="keyword">for</span>(Iterator iter = props.entrySet().iterator();iter.hasNext();) &#123;</div><div class="line">    				  Map.Entry entry = (Map.Entry) iter.next();</div><div class="line">    				  <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">    				  <span class="keyword">for</span>(; i &lt; keys.length; i++) &#123;</div><div class="line">    					  <span class="keyword">if</span>(keys[i].equals(entry.getKey())) <span class="keyword">break</span>;</div><div class="line">    				  &#125;</div><div class="line">    				  <span class="keyword">if</span> (i == keys.length) &#123;</div><div class="line">    					  edited.put(entry.getKey(), entry.getValue());</div><div class="line">    				  &#125;</div><div class="line">    			  &#125;</div><div class="line">    		      PropertySetter.setProperties(eh, edited, errorHandlerPrefix + <span class="string">"."</span>);</div><div class="line">    			  LogLog.debug(<span class="string">"End of errorhandler parsing for \""</span> + appenderName +<span class="string">"\"."</span>);</div><div class="line">    		&#125;</div><div class="line"></div><div class="line">      &#125;</div><div class="line">      <span class="comment">//configureOptionHandler((OptionHandler) appender, prefix + ".", props);</span></div><div class="line">      PropertySetter.setProperties(appender, props, prefix + <span class="string">"."</span>);</div><div class="line">      LogLog.debug(<span class="string">"Parsed \""</span> + appenderName +<span class="string">"\" options."</span>);</div><div class="line">    &#125;</div><div class="line">    parseAppenderFilters(props, appenderName, appender);</div><div class="line">    registryPut(appender);</div><div class="line">    <span class="keyword">return</span> appender;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>该函数负责根据appenderName解析对应的appender配置。<br>首先检查是否已经解析过了，如果已经解析过了，则直接返回。<br><img src="./1505984141490.png" alt="Alt text"><br>然后通过调用<code>OptionConveter.instantizeByKey</code>方法根据配置的appender类名来反射构造一个appender<br><img src="./1505984762810.png" alt="Alt text"></p>
<p><strong>–&gt; –&gt; –&gt;</strong><br><img src="./1505984287906.png" alt="Alt text"></p>
<p><strong>–&gt; –&gt; –&gt;</strong><br><img src="./1505984327046.png" alt="Alt text"></p>
<p>此时会进入到自定义的NamedRollingFileAppender的默认构造函数，创建一个对象，并执行初始化。<br><img src="./1505984569244.png" alt="Alt text"><br>但是需要注意的是，由于调用的是默认构造函数，因此除了显示指定的成员变量值外，其他成员变量没有赋值。<strong>fileName此时也是null。</strong><br><img src="./1505984638152.png" alt="Alt text"></p>
<p>返回到parseAppender之后，NamedRollingFileAppender已经构造完成。此时需要进一步对他进行配置<br><img src="./1505984799252.png" alt="Alt text"></p>
<p>首先配置layout，通过<code>OptionConveter.instantizeByKey</code>反射构造layout对象，并set进appender中：<br><img src="./1505984937102.png" alt="Alt text"></p>
<p>然后通过<code>PropertySetter</code>类对layout中的属性进行设置。<br><img src="./1505984980844.png" alt="Alt text"></p>
<p><code>PropertySetter类</code>利用了Java中的<strong>内省机制</strong>（java.beans.Instrospect），根据剔除前缀后的配置项的key来找到对应的对象中的成员变量，并将配置项的value设置到成员变量中。例如：对于layout的配置<code>log4j.appender.console.layout.ConversionPattern=%d{yyyy-MM-dd HH:mm:ss} [%5p] - %c -%F(%L) -%m%n</code>，<code>PropertySetter</code>会根据前缀<code>log4j.appender.console.layout</code>进行匹配，然后提取<code>ConversionPattern</code>这个key，通过<code>getPropertyDescriptor(Introspector.decapitalize(key))</code>来内省地获取已经构造的layout对象中的对应属性，并通过set函数完成设值。<br><img src="./1505985230417.png" alt="Alt text"></p>
<p>layout初始化完毕之后，进行appender的初始化。这里与layout的做法相同，也是通过<code>PropertySetter</code>将配置设置到对象中去。这些都完成后就一个Logger就正式初始化完毕，可以被使用了。<br><img src="./1505985546690.png" alt="Alt text"></p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>以上就是整个Logger从构造到初始化完成的大致源码流程。那么回到上面的BUG上，显然在进行最后一步appender的内省赋值之前，fileName都是为null的。内省赋值会根据配置项的key依次调用对应的set函数进行设置，比如配置了<code>log4j.appender.FILE.maxBackUpIndex</code>就会被反射调用<code>setMaxBackUpIndex</code>函数，配置了<code>log4j.appender.FILE.File</code>就会被反射地调用<code>setFile</code>函数。</p>
<p>那么问题的关键其实就是，<strong>调用<code>setMaxBackUpIndex</code>函数时fileName没有被正确的设置，也就是<code>setMaxBackUpIndex</code>在<code>setFile</code>之前被反射调用了。</strong><br>根据<code>PropertySetter.setProperties()</code>的源码，我们不难分析出原因：</p>
<blockquote>
<p>由于<code>Properties</code>内部是以<code>HashTable</code>的方式存储配置项的，因此在遍历配置项的时候，是按照key值的所在的hash桶来顺序访问。而这个顺序是随着不同的配置项的名称而变化的。因此才会出现有些appender名称会先调用<code>setFile</code>函数，而有些appender名称会先调用<code>setMaxBackupIndex</code>函数，从而导致了fileName还没有被设值的情况发生。<br><img src="./1505985904866.png" alt="Alt text"></p>
</blockquote>
<p>为了验证上面解释，我们在不同的appender名字下，debug观察Properties中HashTable的元素的顺序：</p>
<ul>
<li>配置<code>log4j.appender.FILE</code>的情况下：<code>log4j.appender.FILE.MaxBackUpIndex</code>排在<code>log4j.appender.FILE.File</code>前面：<br><img src="./1505986408250.png" alt="Alt text"></li>
<li>配置配置<code>log4j.appender.file</code>的情况下：<code>log4j.appender.file.MaxBackUpIndex</code>排在<code>log4j.appender.file.File</code>后面：<br><img src="./1505986360244.png" alt="Alt text"></li>
</ul>
<p>因此造成问题的根源就在于此。</p>
<h2 id="如何FIX"><a href="#如何FIX" class="headerlink" title="如何FIX"></a>如何FIX</h2><p>从源码级别的分析可以知道，由于Properties内的HashTable不能保证顺序，因此我们不能将加载FILO队列的逻辑放到任何设值函数中。解决方案就是<strong>在<code>rollOver()</code>开始处添加</strong>，这样可以保证任何设置函数都已经执行完毕，<code>fileName</code>和<code>maxBackupIndex</code>都已经正确获得了配置值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="comment">// synchronization not necessary since doAppend is alreasy synched</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rollOver</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// 如果没有在log4j中配置maxBackupIndex，那么set函数不会被调用，因此要在这里检查existedLogFileNames队列是否成功初始化</span></div><div class="line">        restoreBackUpsIfNull();</div><div class="line">        ...</div></pre></td></tr></table></figure>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a href="http://blog.csdn.net/s464036801/article/details/22915963" target="_blank" rel="external">http://blog.csdn.net/s464036801/article/details/22915963</a></li>
</ul>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/log4j/" rel="tag">#log4j</a>
          
            <a href="/tags/RollingFileAppender/" rel="tag">#RollingFileAppender</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/01/08/how-to-analysis-java-application-using-jstack/" rel="next" title="如何用jstack命令分析java应用的性能问题">
                <i class="fa fa-chevron-left"></i> 如何用jstack命令分析java应用的性能问题
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


        </div>

        


        
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/09/19/customize-rollingFileAppender-inlog4j/"
           data-title="定制log4j中的RollingFileAppender" data-url="http://paranoidq.github.io/2017/09/19/customize-rollingFileAppender-inlog4j/">
      </div>
    
  </div>


      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/avatar.jpg" alt="Paranoid Qian" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Paranoid Qian</p>
        </div>
        <p class="site-description motion-element" itemprop="description">So we beat on, boats against the current, borne back ceaselessly into the past.</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/tags/碎片/">
              <span class="site-state-item-count">74</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">25</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">76</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/paranoidq" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/2094289700/profile?topnav=1&wvr=6&is_all=1" target="_blank">
                  
                    <i class="fa fa-globe"></i> weibo
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">友情链接</p>
            
              <span class="links-of-author-item">
                <a href="http://macshuo.com/" target="_blank">MacTalk</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.hollischuang.com/" target="_blank">HollisChuang</a>
              </span>
            
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#场景描述"><span class="nav-number">1.</span> <span class="nav-text">场景描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#具体方案"><span class="nav-number">2.</span> <span class="nav-text">具体方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行测试及BUG出现"><span class="nav-number">3.</span> <span class="nav-text">运行测试及BUG出现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码级别的问题定位"><span class="nav-number">4.</span> <span class="nav-text">源码级别的问题定位</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-Logger调用LoggerManager-getLogger-clazz-getName-："><span class="nav-number">4.0.0.1.</span> <span class="nav-text">1. Logger调用LoggerManager.getLogger(clazz.getName())：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-LoggerManager中会从LoggerRepository中根据名称获取Logger"><span class="nav-number">4.0.0.2.</span> <span class="nav-text">2. LoggerManager中会从LoggerRepository中根据名称获取Logger</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-初始化块做了几件事情："><span class="nav-number">4.0.0.3.</span> <span class="nav-text">3. 初始化块做了几件事情：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-OptionConverter"><span class="nav-number">4.0.0.4.</span> <span class="nav-text">4.  OptionConverter</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-PropertyConfigurator"><span class="nav-number">4.0.0.5.</span> <span class="nav-text">5. PropertyConfigurator</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#5-1-configureRootCategory"><span class="nav-number">4.0.0.5.1.</span> <span class="nav-text">5.1 configureRootCategory</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-2-configureLoggerFactory"><span class="nav-number">4.0.0.5.2.</span> <span class="nav-text">5.2 configureLoggerFactory</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-3-parseCatsAndRenders"><span class="nav-number">4.0.0.5.3.</span> <span class="nav-text">5.3 parseCatsAndRenders</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-4-parseCategory"><span class="nav-number">4.0.0.5.4.</span> <span class="nav-text">5.4 parseCategory</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-5-parseAppender"><span class="nav-number">4.0.0.5.5.</span> <span class="nav-text">5.5 parseAppender</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#问题分析"><span class="nav-number">5.</span> <span class="nav-text">问题分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何FIX"><span class="nav-number">6.</span> <span class="nav-text">如何FIX</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考链接"><span class="nav-number">7.</span> <span class="nav-text">参考链接</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Paranoid Qian</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"paranoidq"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.2" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    motionMiddleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');
      if (CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    };
  });
</script>



  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  
  

</body>
</html>
